/*! ld30_game 2014-08-29 */
function Item(a,b,c){this._type=a,this._x=b,this._y=c,this._weight=1,this._slot=0,this._baseValue=1,this._name="Test "+a+" Object",this._sprite=null,this.i=0,this._properties={}}function Map(a){this._data=a}function NPC(a,b,c){this._type=a,this._x=b,this._y=c,this._name="Test "+a+" NPC",this._health=100,this._attack=5,this._attack_range=1,this._sprite=null,this._meta=null}function Player(a,b){this._username=a,this._password=b,this._created=(new Date).getTime(),this._attack=20,this._attack_range=1,this._facing="down",this._homeworld=!1,this._home_pos=!1,this._socket=!1,this._zone="login",this._world="login",this._pos=[0,0],this._health=100,this._vel=[0,0],this._anim="standing",this._kills=0,this._bag=[],this._equip=[],this._model=!1,playerCount++}function SimplexNoise(a){"undefined"==typeof a&&(a=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[];for(var b=0;256>b;b++)this.p[b]=Math.floor(256*a.random());this.perm=[];for(var c=0;512>c;c++)this.perm[c]=this.p[255&c];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}function UI(a){this.game=a,this.menu=!1}function World(a,b){this._model=!1,this._name="Test World",this._seed="Test World",this._size=a,this._width=a,this._height=b,this._id_player=null,this._is_primary=!1,this._npcs=[],this._mapData=[],this._mapObjects=[],this._items=[],this._current_players=1,this._player_list={},this._map=null,this._spawnPoint=[0,0],this._biome=cnf.BIOME_GRASS,this._portals=[],this.linked_portal=!1,"undefined"==typeof module&&(this._map=new Map),this.distTiles=function(a,b,c,d){return Math.floor(Math.sqrt(Math.abs(a-c)*Math.abs(a-c)+Math.abs(b-d)*Math.abs(b-d)))}}function showAlert(a){$("#alert_modal div.msg").html(a),$("#alert_modal").modal("show")}if("undefined"!=typeof module&&(module.exports=Item),"undefined"!=typeof module&&(module.exports=Map),"undefined"!=typeof module&&(module.exports=NPC),"undefined"!=typeof module)var Item=require("./Item");var playerCount=0;if(Player.prototype.playerCount=function(){return playerCount},Player.prototype.login=function(a){return a!=this._password?!1:!0},Player.prototype.setSocket=function(a){this._socket=a},Player.prototype.getProfile=function(){return{username:this._username,health:this._health,vel:this._vel,bag:this._bag,equip:this._equip,zone:this._zone,homeworld:this._homeworld,attack:this._attack,attack_range:this._attack_range,facing:this._facing,kills:this._kills,pos:this._pos,created:this._created}},Player.prototype.setProfile=function(a){this._username=a.username,this._health=a.health,this._vel=a.vel,this._equip=a.equip,this._zone=a.zone,this._pos=a.pos,this._created=a.created,this._world=a.world},Player.prototype.updateDisplay=function(){console.log("display for ",this),$("#info_username").html(this._username),$("#info_zone").html(this._zone+" ["+this._pos[0]+","+this._pos[1]+"]"),$("#info_health").html(this._health)},Player.prototype.sendPing=function(){this._startPing=(new Date).getTime(),this._socket.emit("ping",{})},Player.prototype.receivePing=function(){this._endPing=(new Date).getTime(),this._latency=this._endPing-this._startPing,this._socket&&this._socket.emit("info",{latency:this._latency})},"undefined"!=typeof module&&(module.exports=Player),SimplexNoise.prototype.dot=function(a,b,c){return a[0]*b+a[1]*c},SimplexNoise.prototype.noise=function(a,b){var c,d,e,f,g,h=.5*(Math.sqrt(3)-1),i=(a+b)*h,j=Math.floor(a+i),k=Math.floor(b+i),l=(3-Math.sqrt(3))/6,m=(j+k)*l,n=j-m,o=k-m,p=a-n,q=b-o;p>q?(f=1,g=0):(f=0,g=1);var r=p-f+l,s=q-g+l,t=p-1+2*l,u=q-1+2*l,v=255&j,w=255&k,x=this.perm[v+this.perm[w]]%12,y=this.perm[v+f+this.perm[w+g]]%12,z=this.perm[v+1+this.perm[w+1]]%12,A=.5-p*p-q*q;0>A?c=0:(A*=A,c=A*A*this.dot(this.grad3[x],p,q));var B=.5-r*r-s*s;0>B?d=0:(B*=B,d=B*B*this.dot(this.grad3[y],r,s));var C=.5-t*t-u*u;return 0>C?e=0:(C*=C,e=C*C*this.dot(this.grad3[z],t,u)),70*(c+d+e)},SimplexNoise.prototype.noise3d=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=1/3,o=(a+b+c)*n,p=Math.floor(a+o),q=Math.floor(b+o),r=Math.floor(c+o),s=1/6,t=(p+q+r)*s,u=p-t,v=q-t,w=r-t,x=a-u,y=b-v,z=c-w;x>=y?y>=z?(h=1,i=0,j=0,k=1,l=1,m=0):x>=z?(h=1,i=0,j=0,k=1,l=0,m=1):(h=0,i=0,j=1,k=1,l=0,m=1):z>y?(h=0,i=0,j=1,k=0,l=1,m=1):z>x?(h=0,i=1,j=0,k=0,l=1,m=1):(h=0,i=1,j=0,k=1,l=1,m=0);var A=x-h+s,B=y-i+s,C=z-j+s,D=x-k+2*s,E=y-l+2*s,F=z-m+2*s,G=x-1+3*s,H=y-1+3*s,I=z-1+3*s,J=255&p,K=255&q,L=255&r,M=this.perm[J+this.perm[K+this.perm[L]]]%12,N=this.perm[J+h+this.perm[K+i+this.perm[L+j]]]%12,O=this.perm[J+k+this.perm[K+l+this.perm[L+m]]]%12,P=this.perm[J+1+this.perm[K+1+this.perm[L+1]]]%12,Q=.6-x*x-y*y-z*z;0>Q?d=0:(Q*=Q,d=Q*Q*this.dot(this.grad3[M],x,y,z));var R=.6-A*A-B*B-C*C;0>R?e=0:(R*=R,e=R*R*this.dot(this.grad3[N],A,B,C));var S=.6-D*D-E*E-F*F;0>S?f=0:(S*=S,f=S*S*this.dot(this.grad3[O],D,E,F));var T=.6-G*G-H*H-I*I;return 0>T?g=0:(T*=T,g=T*T*this.dot(this.grad3[P],G,H,I)),32*(d+e+f+g)},"undefined"!=typeof module&&(module.exports=SimplexNoise),UI.prototype.addGameUI=function(){game.uigroup=game._p.add.group(void 0,"uigroup"),game.uigroup.fixedToCamera=!0,game.uisprites={},game.uisprites.heart=game._p.add.sprite(20,10,"items","heartgem"),game.uisprites.heart_text=game._p.add.text(80,20,"100",{font:"20px Arial",fill:"#ff3333"}),game.uisprites.trophy=game._p.add.sprite(400,10,"items","antlertrophy"),game.uisprites.trophy_text=game._p.add.text(450,20,"0",{font:"20px Arial",fill:"#ff3333"});for(var a in game.uisprites)game.uisprites[a].fixedToCamera=!0,game.uisprites[a].bringToTop?game.uisprites[a].bringToTop():game.uisprites[a].parent.bringToTop(game.uisprites[a])},UI.prototype.updateGame=function(a){game.uisprites.heart_text.destroy(),game.uisprites.trophy_text.destroy(),game.uisprites.heart_text=game._p.add.text(60,20,""+a._health,{font:"20px Arial",fill:"#ff3333"}),game.uisprites.heart_text.fixedToCamera=!0,game.uisprites.trophy_text=game._p.add.text(440,20,""+a._kills,{font:"20px Arial",fill:"#ff3333"}),game.uisprites.trophy_text.fixedToCamera=!0;for(var b in game.uisprites)game.uisprites[b].bringToTop&&game.uisprites[b].bringToTop()},UI.prototype.liClicked=function(a){console.log("List clicked",a);var b=parseInt($(a).attr("data-i"));null!==b&&game.ui.menu&&game.ui.menu[b]&&(console.log("option: ",game.ui.menu[b]),game.ui.menu[b].cb?game.ui.menu[b].cb():game.ui.closeMenu())},UI.prototype.keyPress=function(a){if(game.menuOpen&&game.ui.menu)if("up"==a||"down"==a){var b=$("li.menu_selected div").length>0?parseInt($("li.menu_selected div").attr("data-i")):0;$("li.menu_selected").removeClass("menu_selected");var c=b;"up"==a&&0===b?c=game.ui.menu.length-1:"up"==a?c=b-1:"down"==a&&b>=game.ui.menu.length-1?c=0:"down"==a&&(c=b+1),console.log("UI switch to menu option "+c),$('div[data-i="'+c+'"]').parent().addClass("menu_selected")}else if("space"==a){if($("li.menu_selected div").length<1)return;$("li.menu_selected div").click()}},UI.prototype.closeMenu=function(){game.ui.menu=!1,game.menu=!1,game.menuOpen=!1,$("#menu_modal div.close").click()},UI.prototype.showMenu=function(a){var b=a.header?a.header:"Menu",c=a.msg?a.msg:"";if($("#menu_modal h3").html(b),$("#menu_text").html(c),$("#menu_list").children().remove(),a.menu){game.ui.menu=a.menu,game.menu=a.menu;for(var d=0;d<a.menu.length;d++){var e='<li class="menu_list '+(0===d?"menu_selected":"")+'"><div data-i="'+d+'" onClick="game.ui.liClicked(this);">'+a.menu[d].txt+"</div></li>";$("#menu_list").append(e)}}console.log("Menu shown!",a),$("#menu_modal").modal(),game.menuOpen=!0},"undefined"!=typeof module)var cnf=require("./cnf");if("undefined"!=typeof module)var SimplexNoise=require("./SimplexNoise");if("undefined"!=typeof module)var NPC=require("./NPC");if("undefined"!=typeof module)var Item=require("./Item");World.prototype.generate=function(a,b,c,d){this._name=a?a:b._name+"'s World",this._seed=this._name,console.log("Generating world "+this._name+" ["+this._biome+"] size "+this._size+" for "+b._username+" : "+typeof d),-1===this._biome&&(this._biome=cnf.BIOMES[Math.floor(Math.random()*cnf.BIOMES.length)]),console.log("Generating biome: "+this._biome);var e=new SimplexNoise,f=6,g=[3,4,5],h=[0,1,2],i=[7],j=[6],k=!1,l=[2,4,4,5,5,6,6,6,6,7,7,7,7,8,8,8,8];this._biome==cnf.BIOME_SNOW?(g=[9,10,11],h=[12],l=[2,4,6,6,9,9,9,10,10,10]):this._biome==cnf.BIOME_DESERT?k=Math.random()<.1:this._biome==cnf.BIOME_CITY||(this._biome==cnf.BIOME_LAVA?g=[8,8,8,20,20,20,20,18,18,19,19]:k=Math.random()<.4),this.occupiedTiles={};for(var m=!1,n=0;n<this._width;n++){this._mapData[n]=[];for(var o=0;o<this._height;o++){var p=0;if(k&&4>n)p=15,this._mapData[n][o]=p,this.occupiedTiles[n+","+o]=["tile",p];else if(k&&4==n)p=16,this._mapData[n][o]=p,this.occupiedTiles[n+","+o]=["tile",p];else if(k&&5==n)p=17,this._mapData[n][o]=p;else{var q=(e.noise(n/this._width*f/2,o/this._height*f/2)+1)/2,r=0;switch(this._biome){case cnf.BIOME_GRASS:q>.9?(p=i[0],r=1):q>.65?(p=Math.floor((q-.65)/.35*h.length),p=h[p],r=1):.05>q&&(p=j[0],r=1);break;case cnf.BIOME_DESERT:break;case cnf.BIOME_SNOW:q>.9?(p=h[0],r=1):q>.52&&.6>q?(p=13,r=1):q>=.6&&.67>=q&&(p=14,r=1);break;case cnf.BIOME_FOREST:break;case cnf.BIOME_CITY:}r||(q=(e.noise(n/this._width*f,o/this._height*f)+1)/2,p=Math.floor(q*g.length),p=g[p]),cnf.tiles[p]||(p=0),this._mapData[n][o]=p,n>3&&o>3&&cnf.tiles[p].passable&&b&&!m?(m=!0,b._pos=[n,o]):cnf.tiles[p].passable?(q=Math.random(),q>.92&&(q=Math.floor(Math.random()*l.length),block=l[q],this._mapObjects.push({x:n,y:o,i:block,tile_i:cnf.blocks[block].tile_i}),cnf.blocks[block].passable||(this.occupiedTiles[n+","+o]=["block",this._mapObjects.length-1]))):this.occupiedTiles[n+","+o]=["tile",p]}}}console.log("map generated, populating with npcs");for(var s=25*Math.random()+10,t=!1,u=0,v=0,w=0,x=0;s>x;x++){var y=Math.floor(Math.random()*cnf.NPC_TYPE_LIST.length);for(t=!1,w=0;20>w&&!t;){if(u=Math.floor(Math.random()*this._width),v=Math.floor(Math.random()*this._height),!this.occupiedTiles[u+","+v]){t=[u,v];break}w++}if(t){var z=new NPC(cnf.NPC_TYPE_LIST[y],t[0],t[1]);z._meta=cnf.NPC_ATLAS.frames[cnf.NPC_TYPE_LIST[y]],z._meta.base_health&&(z._health=z._meta.base_health),this._npcs.push(z),this.occupiedTiles[t[0]+","+t[1]]=["npc",this._npcs.length-1]}}var A=15*Math.random()+3;for(x=0;A>x;x++){for(t=!1,w=0;20>w&&!t;){if(u=Math.floor(Math.random()*this._width),v=Math.floor(Math.random()*this._height),!this.occupiedTiles[u+","+v]){t=[u,v];break}w++}if(t){var B=new Item("portal",t[0],t[1]);c.link_portal&&!c.link_portal.linked?(B._name="Portal to "+c.link_portal.world_name,B._properties.is_explored=!0,B._properties.id_world=c.link_portal.id_world,B._properties.remote_id=c.link_portal.id_portal,c.link_portal.linked=!0,this.linked_portal=this._portals.length,console.log("Created link portal: "+this._portals.length+" to world "+c.link_portal.id_world+" portal["+c.link_portal.id_portal+"]")):(B._name="Mysterious Portal",B._properties.is_explored=!1),B.i=this._portals.length,this._portals.push(B),this.occupiedTiles[t[0]+","+t[1]]=["portal",this._portals.length-1]}}15*Math.random()+10;d&&d()},"undefined"!=typeof module&&(module.exports=World);var cnf={title:"Ludum Dare 30",ws_server:"http://10.0.33.34:8001",WORLD_SIZE_PLAYER:60,WORLD_SIZE_MAX:100,WORLD_SIZE_MIN:40,BIOME_GRASS:0,BIOME_SNOW:1,BIOME_DESERT:2,BIOME_CITY:3,BIOME_FOREST:4,BIOME_LAVA:5,TILES_MAX:4,TILE_TREE:0,TILE_GRASS:1,TILE_WATER:2,TILE_ROAD:3,tiles:[{i:0,name:"tree",passable:!0,tile_i:7},{i:0,name:"tree1",passable:!0,tile_i:8},{i:0,name:"tree2",passable:!0,tile_i:9},{i:1,name:"grass",passable:!0,tile_i:0},{i:2,name:"grass1",passable:!0,tile_i:1},{i:3,name:"grass2",passable:!0,tile_i:2},{i:0,name:"dirt",passable:!0,tile_i:38},{i:4,name:"water",passable:!1,tile_i:170},{i:5,name:"road",passable:!0,tile_i:78},{name:"snow",passable:!0,tile_i:45},{name:"snow1",passable:!0,tile_i:46},{name:"snow2",passable:!0,tile_i:47},{name:"snow_tree",passable:!1,tile_i:49},{name:"snow_ice_hole",passable:!0,tile_i:55},{name:"snow_ice",passable:!0,tile_i:60},{name:"water_light",passable:!1,tile_i:166},{name:"shore_left1",passable:!1,tile_i:309},{name:"sand",passable:!0,tile_i:19},{name:"lava",passable:!1,tile_i:562},{name:"lava2",passable:!1,tile_i:563},{name:"slate",passable:!0,tile_i:560}],blocks:[{name:"stairs",passable:!0,interactable:!0,destructable:!1,tile_i:230},{name:"stairs1",passable:!0,interactable:!0,destructable:!1,tile_i:232},{name:"trap_arrow",passable:!0,interactable:!0,destructable:!0,tile_i:234},{name:"door_open",passable:!0,interactable:!0,destructable:!0,tile_i:236},{name:"campfire",passable:!0,interactable:!0,destructable:!0,tile_i:238},{name:"rock",passable:!1,interactable:!1,destructable:!0,tile_i:568},{name:"plant_tiny",passable:!0,interactable:!0,destructable:!0,tile_i:248},{name:"plant_med",passable:!0,interactable:!0,destructable:!0,tile_i:249},{name:"plant_large",passable:!0,interactable:!0,destructable:!0,tile_i:250},{name:"snow_log",passable:!0,interactable:!0,destructable:!0,tile_i:668},{name:"snow_rock",passable:!1,interactable:!0,destructable:!0,tile_i:670}]};cnf.NPC_ATLAS={frames:{portal:{frame:{x:768,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},portal2:{frame:{x:816,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},portal3:{frame:{x:864,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},npcguy:{frame:{x:48,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcguy2:{frame:{x:96,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcguy3:{frame:{x:144,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcgirl:{frame:{x:192,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcgirl2:{frame:{x:48,y:48,w:48,h:48},rotated:!1,trimmed:!1},bloodspurt:{frame:{x:53,y:1160,w:38,h:40},rotated:!1,trimmed:!1,not_npc:!0},ghoul:{frame:{x:288,y:240,w:48,h:48},rotated:!1,trimmed:!1,hostile:!0,base_health:50,speed:2,chase_distance:10},blobbit:{frame:{x:144,y:240,w:48,h:48},rotated:!1,trimmed:!1,hostile:!0,base_health:10,speed:4,chase_distance:10},eye:{frame:{x:430,y:288,w:48,h:48},rotated:!1,trimmed:!1,hostile:!0,flying:!0,speed:4,base_health:15,chase_distance:15}}},cnf.BIOMES=[cnf.BIOME_GRASS,cnf.BIOME_GRASS,cnf.BIOME_GRASS,cnf.BIOME_SNOW,cnf.BIOME_SNOW,cnf.BIOME_FOREST,cnf.BIOME_FOREST,cnf.BIOME_DESERT,cnf.BIOME_LAVA],cnf.NPC_TYPES={},cnf.NPC_TYPE_LIST=[];for(var title in cnf.NPC_ATLAS.frames)"portal"!=title&&"portal2"!=title&&"portal3"!=title&&(cnf.NPC_ATLAS.frames[title].not_npc||(cnf.NPC_TYPES[title]=cnf.NPC_ATLAS.frames[title],cnf.NPC_TYPE_LIST.push(title)));cnf.ITEM_ATLAS={frames:{longstick:{frame:{x:48,y:0,w:48,h:48},rotated:!1,trimmed:!1},bullet:{frame:{x:96,y:0,w:48,h:48},rotated:!1,trimmed:!1},waterwisp:{frame:{x:144,y:0,w:48,h:48},rotated:!1,trimmed:!1},purplesplash:{frame:{x:192,y:0,w:48,h:48},rotated:!1,trimmed:!1},dagger:{frame:{x:144,y:624,w:40,h:40},rotated:!1,trimmed:!1},heartgem:{frame:{x:98,y:48,w:48,h:48},rotated:!1,trimmed:!1},antlertrophy:{frame:{x:768,y:768,w:48,h:48},rotated:!1,trimmed:!1}}},cnf.ITEM_TYPES={},cnf.ITEM_TYPE_LIST=[];for(var title in cnf.ITEM_ATLAS.frames)cnf.ITEM_TYPES[title]=cnf.ITEM_ATLAS.frames[title],cnf.ITEM_TYPE_LIST.push(title);cnf.TILES_MAX=cnf.tiles.length,"undefined"!=typeof module&&(module.exports=cnf),CreateGame=function(a){return this._canvasID=a,this._canvasE=document.getElementById(a),this._socket=!1,this._connected=!1,this._authenticated=!1,this._zone=!1,this._world=!1,this._player=!1,this._primary_world=!1,this._player_list={},this._local=!1,this._uisprites={},this._canvasE?(this._canvasW=$(this._canvasE).width(),this._canvasH=$(this._canvasE).height(),this._canvasH||(this._canvasH=500),this.init=function(){this._p=new Phaser.Game(this._canvasW,this._canvasH,Phaser.CANVAS,this._canvasID,{preload:this.preload,create:this.create,update:this.update,render:this.render}),this._socket=io(web_cnf.ws_server),this.ui=new UI(this);var a=this;$("#info_server").html("Connecting.."),$("#frm_msg").on("submit",function(){return console.log("form submitted! ",a.send_msg),a.send_msg(),!1}),$("#frm_warp").on("submit",function(){var b=$("#warp_id").val();if(b&&!(b.length<10))return a._socket.emit("warp",b),showAlert("Requesting warp"),!1}),this._socket.on("connect",function(){$("#info_server").html("Connected"),hideSpinner(),a._connected=!0,a._local||(a._world?(console.log("attempting to login automatically"),a._login_params.id_world=a._world._model._id,showSpinner("Reconnecting..")):$("#login_modal").modal("show"),console.log("socket connect"))}),this._socket.on("connect_error",function(){console.log("Connect Error!"),$("#info_server").html("Connect Failed"),showSpinner("Server Disconnected"),a.playable=!1,a._connected=!1}),this._socket.on("disconnect",function(){console.log("Server Disconnected!"),$("#info_server").html("Disconnected"),showSpinner("Server Disconnected")}),this._socket.on("alert",function(a){console.log("alert",a),showAlert(a)}),this._socket.on("pc",function(b){b.name!=a._player._username&&(console.log("pc",b),a._player_list[b.name]&&b.pos&&a.movePlayerTo(pos[0],pos[1],a._player_list[b.name]))}),this._socket.on("pc list",function(b){console.log("pc list",b),a.loadPlayers(b)}),this._socket.on("pc join",function(b){if(b.name!=a._player._username){console.log("pc join",b);var c=new Player(b.name,"");c._pos=b.pos,c.sprite=a._p.add.sprite(10,10,"chr1"),c.sprite.animations.add("walk",[0,1,2,3]),c.sprite.animations.add("stand",[0]),c.sprite.animations.play("stand",0),c.sprite.animations.add("walk_left",[4,5,6,7]),c.sprite.animations.add("walk_right",[8,9,10,11]),c.sprite.animations.add("walk_up",[12,13,14,15]),c.sprite.anchor.setTo(.5,.5),c.sprite.z=10,c.curTile=a.map.getTile(c._pos[0],c._pos[1],"world"),c.sprite.x=c.curTile.worldX+c.sprite.width/2,c.sprite.y=c.curTile.worldY+c.sprite.height/4,c.label=a._p.add.text(c.sprite.x,c.curTile.worldY-30,c._username,pStyle,a.spriteGroup),c.sprite.bringToTop(),c.label.bringToTop(),a._player_list[b.name]=c,console.log(a._world._player_list)}}),this._socket.on("pc leave",function(b){a._player._username!=b.name&&(console.log("pc leave",b),a._player_list[b.name]&&(a._player_list[b.name].sprite&&a._player_list[b.name].sprite.destroy(!0),delete a._player_list[b.name]))}),this._socket.on("login",function(b){console.log("login response",b),processingLogin=!1,$("#login_modal").css("display","none"),$("div.modal-backdrop").css("display","none"),b.status?($("#info_server").html("Logged In"),a._player||a._world?(console.log("Reconnected"),hideSpinner(),a.playable=!0):(a._player=new Player(a._login_params.user,a._login_params.pwd),a._player.setProfile(b.profile),a._player.updateDisplay(),$("div.right").slideDown(),a._player.updateDisplay(),showSpinner("Loading "+a._player._zone))):(showAlert(b.err),hideSpinner())}),this._socket.on("world",function(b,c){"string"==typeof b&&(b=JSON.parse(b)),a.playable=!1,showSpinner("Loading world: "+b._name),console.log("Received world data from server!",b,c),a._world=b,a._player._world=b,b._is_primary&&!a._primary_world&&(a._primary_world={id:b._model._id,name:b._name,pos:c}),$("#info_zone").html(b._name),$("#info_zone_id").html(b._model._id),$("#login_modal").modal("hide"),a.loadWorld(c)}),this._socket.on("chat message",function(b){a.received_msg(b.user,b.msg)}),this._socket.on("player login",function(b){a.received_msg("System",b+" has logged in")}),this._socket.on("npc",function(b){if(a._world._npcs[b[0]])if(b.length>1&&"move"==b[1]){var c=a.map.getTile(b[2],b[3],"world"),d=a._world.occupiedTiles[a._world._npcs[b[0]]._x+","+a._world._npcs[b[0]]._y];delete a._world.occupiedTiles[a._world._npcs[b[0]]._x+","+a._world._npcs[b[0]]._y],a._world._npcs[b[0]].sprite.x=c.worldX+10,a._world._npcs[b[0]].sprite.y=c.worldY+10,a._world._npcs[b[0]]._x=b[2],a._world._npcs[b[0]]._y=b[3],a._world._npcs[b[0]].curTile=c,a._world.occupiedTiles[a._world._npcs[b[0]]._x+","+a._world._npcs[b[0]]._y]=d}else if(b.length>1&&"kill"==b[1]){console.log("npc killed!",b);var e=a._world._npcs[b[0]].curTile,f=a._p.add.emitter(e.worldX+e.width/2,e.worldY+e.height/2,30);f.makeParticles("npcs",["bloodspurt"],50),f.maxParticleSpeed=22.5,f.start(!0,1e3),a._player._kills++,a._world._npcs[b[0]].sprite.destroy(),a._world._npcs[b[0]]=null,delete a._world.occupiedTiles[e.x+","+e.y],a.ui.updateGame(a._player)}}),this._socket.on("ping",function(){a._socket.emit("ping")}),this._socket.on("info",function(b){"undefined"!=typeof b.latency&&$("#info_latency").html(b.latency+"ms"),"undefined"!=typeof b.position&&($("#info_position").html("x:"+b.position[0]+" y:"+b.position[1]),a.movePlayerTo(b.position[0],b.position[1])),"undefined"!=typeof b.zone&&$("#info_zone").html(b.zone)}),this._socket.on("player update",function(b){console.log("player update",b);for(var c in b)a._player[c]=b[c]})},this.updatePlayerUI=function(){},this.received_msg=function(a,b){console.log("received chat",b);var c='<li style="float:left; width:100%;"><div style="float:left;max-width: 80px; font-weight: bold; margin-right: 5px; overflow-x:hidden;">';c+=a+"</div><div style='float:left;max-width:120px;overflow-x:wrap;'>"+b+"</div></li>",$("#chat_messages").append(c),$("#chat_div").scrollTop($("#chat_messages").height())},this.send_msg=function(){var a=$("#msg").val();!a||a.length<2||self._socket&&self._connected&&(console.log("sending msg",a),self._socket.emit("chat message",a))},this.preload=function(){console.log("Preloading .. "),self._p.load.image("tileset_map","assets/elona/map1tp.png"),self._p.load.spritesheet("chr1","assets/elona/char1.png",32,48),self._p.load.atlasJSONHash("npcs","assets/elona/npcs.png",null,cnf.NPC_ATLAS),self._p.load.atlasJSONHash("items","assets/elona/items.png",null,cnf.ITEM_ATLAS)},this.create=function(){console.log("Game created .. "),self.mapGroup=self._p.add.group(void 0,"map"),self.spriteGroup=self._p.add.group(void 0,"sprites"),self.map=self._p.add.tilemap(),self.map.addTilesetImage("tileset_map","tileset_map",48,48),self._worldLayer=self.map.create("world",60,60,48,48),self._worldLayer.resizeWorld(),self.npcguy=self._p.add.sprite(200,200,"npcs","npcguy"),self.sprite=self._p.add.sprite(10,10,"chr1"),self.sprite.animations.add("walk",[0,1,2,3]),self.sprite.animations.add("stand",[0]),self.sprite.animations.play("stand",0),self.sprite.animations.add("walk_left",[4,5,6,7]),self.sprite.animations.add("walk_right",[8,9,10,11]),self.sprite.animations.add("walk_up",[12,13,14,15]),self.sprite.anchor.setTo(.5,.5),self.sprite.z=10,console.log("sprite created",self.sprite),self.cursors=self._p.input.keyboard.createCursorKeys(),self.cursors.space=self._p.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),self.cursors.enter=self._p.input.keyboard.addKey(Phaser.Keyboard.ENTER),self.cursors.left.onDown.add(self.left),self.cursors.up.onDown.add(self.up),self.cursors.down.onDown.add(self.down),self.cursors.right.onDown.add(self.right),self.cursors.enter.onDown.add(self.space),self.cursors.space.onDown.add(self.space),self.map.fill(0,0,0,60,60,self.map.currentLayer),self._p.camera.follow(self.sprite),self._local&&(self.test_world=new World(60,30),self.test_world._biome=-1,self.test_world.generate("Test World",self._player,function(){console.log("test world generated"),self._world=self.test_world,self._player._pos||(self._player._pos=[20,20]),self.loadWorld(self._player._pos)})),self.ui.addGameUI()},this.update=function(){},this.up=function(){if(self.menuOpen)return void self.ui.keyPress("up");if(self.playable){self.sprite.animations.play("walk_up",3),self._player._facing="up";var a=self.map.getTileAbove(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y))}},this.down=function(){if(self.menuOpen)return void self.ui.keyPress("down");if(self.playable){self.sprite.animations.play("walk",3),self._player._facing="down";var a=self.map.getTileBelow(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y))}},this.left=function(){if(self.menuOpen)return void self.ui.keyPress("left");if(self.playable){self.sprite.animations.play("walk_left",3),self._player._facing="left";var a=self.map.getTileLeft(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y))}},this.right=function(){if(self.menuOpen)return void self.ui.keyPress("right");if(self.playable){self.sprite.animations.play("walk_right",3),self._player._facing="right";var a=self.map.getTileRight(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y))}},this.space=function(){if(self.menuOpen)return void self.ui.keyPress("space");if(self.playable){var a=!1;if("up"==self._player._facing?a=self.getTiles(self._player._pos[0],self._player._pos[1]-1):"down"==self._player._facing?a=self.getTiles(self._player._pos[0],self._player._pos[1]+1):"left"==self._player._facing?a=self.getTiles(self._player._pos[0]-1,self._player._pos[1]):"right"==self._player._facing&&(a=self.getTiles(self._player._pos[0]+1,self._player._pos[1])),!(a===!1||a.length<2)){var b=a[1];if("npc"==a[1][0]){var c=self._p.add.emitter(a[0].worldX+a[0].width/2,a[0].worldY+a[0].height/2,30);c.makeParticles("npcs",["bloodspurt"]),c.maxParticleSpeed=12.5,c.start(!0,1e3,3);var d=self._world._npcs[b[1]];d._meta.hostile=!0,d&&!d.lbl&&(d.lbl=self._p.add.text(d.sprite.x-10,d.sprite.y-35,"Ouch!",{font:"16px Arial",fill:"#330000"},self.spriteGroup),setTimeout(function(){d.lbl.destroy(),d.lbl=!1},1e3)),d._health-=self._player._attack,self._socket.emit("attack",b[1])}}}},this.render=function(){self._p.debug.text("Current Layer: "+self.map.layers[self.map.currentLayer].name,16,550)},this.loadWorld=function(a){showAlert("World data received - creating display"),console.log("world data recieived - creating display",a),$("#info_zone").html(self._world._name);var b=self.map.create("world",self._world._mapData.length,self._world._mapData[0].length,48,48);self._worldlayer=b,b.resizeWorld();for(var c=null,d=0;d<self._world._mapData.length;d++)for(var e=0;e<self._world._mapData[d].length;e++)c=self.map.putTile(cnf.tiles[self._world._mapData[d][e]].tile_i,d,e,"world"),c.properties.i=self._world._mapData[d][e],c.properties.passable=cnf.tiles[self._world._mapData[d][e]].passable;console.log("Creating "+self._world._mapObjects.length+" blocks");var f=self.map.createBlankLayer("blocks",self._world._mapData.length,self._world._mapData[0].length,48,48);self._blocklayer=f;for(var g=0;g<self._world._mapObjects.length;g++)c=self.map.putTile(self._world._mapObjects[g].tile_i,self._world._mapObjects[g].x,self._world._mapObjects[g].y,"blocks"),c.properties.i=self._world._mapObjects[g].i,cnf.blocks[self._world._mapObjects[g].i]?(c.properties.passable=cnf.blocks[self._world._mapObjects[g].i].passable,c.properties.interactable=cnf.blocks[self._world._mapObjects[g].i].interactable):console.log("invalid block",self._world._mapObjects[g]);console.log("map layer set");var h=null;for(g=0;g<self._world._npcs.length;g++)self._world._npcs[g]&&(h=self.map.getTile(self._world._npcs[g]._x,self._world._npcs[g]._y,"world"),self._world._npcs[g].curTile=h,self._world._npcs[g].sprite=self._p.add.sprite(h.worldX,h.worldY,"npcs",self._world._npcs[g]._type),self._world._npcs[g].sprite.anchor.setTo(.5,.5),self._world._npcs[g].sprite.y+=self._world._npcs[g].sprite.height/4,self._world._npcs[g].sprite.x+=self._world._npcs[g].sprite.width/2,self._world.occupiedTiles[h.x+","+h.y]=["npc",g]);for(g=0;g<self._world._portals.length;g++)h=self.map.getTile(self._world._portals[g]._x,self._world._portals[g]._y,"world"),self._world._portals[g].curTile=h,self._world._portals[g].sprite=self._p.add.sprite(h.worldX,h.worldY,"npcs"),self._world._portals[g].sprite.animations.add("bzz",["portal","portal2","portal3","portal2"],8*Math.random()+2,!0),self._world._portals[g].sprite.animations.play("bzz"),self._world._portals[g].sprite.anchor.setTo(.5,.5),self._world._portals[g].sprite.x+=self._world._portals[g].sprite.width/2,self._world.occupiedTiles[h.x+","+h.y]=["portal",g];var i=Math.floor(self._world._width/2);a?self.movePlayerTo(a[0],a[1],null,!0):self.movePlayerTo(i,Math.floor(self._world._height/2)),self.playable=!0,self._p.camera.follow(self.sprite),hideSpinner(),$("#login_modal").modal("hide"),console.log("loadWorld Finished"),setTimeout(function(){self._player._pos||(self._player._pos=[10,10],self.curTile=self.map.getTile(10,10,"world"),self.sprite.x=self.curTile.worldX+self.sprite.width/2,self.sprite.y=self.curTile.worldY+self.sprite.height/4),self.curTile=self.map.getTile(self._player._pos[0],self._player._pos[1],"world"),self.movePlayerTo(self._player._pos[0],self._player._pos[1]),self.sprite.bringToTop();for(var a=0;a<self.spriteGroup.children.length;a++)self.spriteGroup.bringToTop(self.spriteGroup.children[a]);self.ui.updateGame(self._player)},100)},this.movePlayerTo=function(a,b,c,d){var e=self.map.getTile(a,b,"world"),f=self.map.getTile(a,b,"blocks");if(!d&&f&&!f.properties.passable)return!1;if(console.log(e),!d&&e.properties.passable===!1)return!1;if(!d&&(!self.curTile||self._world.occupiedTiles[a+","+b]&&"pc"!=self._world.occupiedTiles[a+","+b][0])){var g=self._world.occupiedTiles[a+","+b];if(console.log("Tile occupied",g),"npc"==g[0]){if(self._world._npcs[g[1]]&&!self._world._npcs[g[1]]._meta.hostile){var h=self._p.add.text(e.worldX,e.worldY-20,"Oof!",{font:"16px Arial",fill:"#000000"});setTimeout(function(){h.destroy()},1e3)}}else if("portal"==g[0]){var i=self._world._portals[g[1]],j={header:i._name,msg:"This portal leads to another world which may be dangerous but also full of wonders. Step through at your own peril",menu:[{txt:"Step Away"},{txt:"Bravely Pass Through",cb:function(){self.activatePortal(g[1])}}]};console.log("showing portal menu"),self.ui.showMenu(j)}return!1}return $("#info_position").html(a+" , "+b),c?(c._pos=[a,b],c.curTile=e,c.sprite&&(c.sprite.x=e.worldX+c.sprite.width/2,c.sprite.y=e.worldY+c.sprite.height/4),c.label&&(c.label.x=e.worldX+c.sprite.width/2,c.label.y=e.worldY-20),!0):(self._player._pos=[a,b],self.curTile=e,self.sprite.x=e.worldX+self.sprite.width/2,self.sprite.y=e.worldY+self.sprite.height/4,self._socket.emit("move",[a,b]),!0)},this.activatePortal=function(a){self._world._portals[a]||(showAlert("Unable to find portal "+a+"!"),self.ui.closeMenu()),console.log("load world! ",self._world._portals[a]),showSpinner("Activating World Portal"),self.ui.closeMenu(),self.playable=!1;var b={portal_i:a};self._world._portals[a]._properties.is_explored&&(b.id_world=self._world._portals[a]._properties.id_world,b.portal_to=self._world._portals[a]._properties.remote_id),self._socket.emit("warp",b)},this.doLogin=function(a){return self._connected?(showSpinner("Logging In.."),self._login_params=a,void self._socket.emit("login",a)):void console.log("Cant login not connected")},this.loadPlayers=function(a){self.clearPlayerSprites(),console.log("loadPlayers sprites cleared");for(var b in a)if(console.log(a[b].name),a[b].name!=self._player._username){var c={font:"12px Arial",fill:"#ff0044",align:"center"},d=new Player(a[b].name,"");self._player_list[a[b].name]=d,d._pos=a[b].pos,d.sprite=self._p.add.sprite(10,10,"chr1"),d.sprite.animations.add("walk",[0,1,2,3]),d.sprite.animations.add("stand",[0]),d.sprite.animations.play("stand",0),d.sprite.animations.add("walk_left",[4,5,6,7]),d.sprite.animations.add("walk_right",[8,9,10,11]),d.sprite.animations.add("walk_up",[12,13,14,15]),d.sprite.anchor.setTo(.5,.5),d.sprite.z=10,d.curTile=self.map.getTile(d._pos[0],d._pos[1],"world"),d.sprite.x=d.curTile.worldX+d.sprite.width/2,d.sprite.y=d.curTile.worldY+d.sprite.height/4,d.label=self._p.add.text(d.sprite.x,d.curTile.worldY-30,d._username,c,self.spriteGroup),d.sprite.bringToTop(),d.label.bringToTop(),self._player_list[a[b].name]=d,console.log("added player",d)
}console.log("loaded players",self._player_list.length)},this.getTiles=function(a,b){if(0>a||a>self._world._width)return!1;if(0>b||b>self._world._height)return!1;var c=[];return c[0]=self.map.getTile(a,b,"world"),self._world.occupiedTiles[a+","+b]&&(c[1]=self._world.occupiedTiles[a+","+b]),c},this.clearPlayerSprites=function(){for(var a in self._player_list)self._player_list.sprite.destroy();self._player_list={}},this.closeMenu=function(){self.menuOpen=!1,self.menu=!1},self):(alert("Missing canvas!"),!1)},console.log("ld30 game loaded - yay");