/*! ld30_game 2014-08-23 */
function Map(a){this._data=a}function NPC(a,b,c){this._type=a,this._x=b,this._y=c,this._name="Test "+a+" NPC",this._sprite=null}function Player(a,b){this._username=a,this._password=b,this._created=(new Date).getTime(),this._socket=!1,this._zone="login",this._world="login",this._pos=[0,0],this._health=100,this._vel=[0,0],this._anim="standing",this._bag=[],this._equip={},this._model=!1,playerCount++}function World(a){this._model=!1,this._name="Test World",this._seed="Test World",this._size=a,this._id_player=null,this._npcs=[],this._mapData=[],this._current_players=1,this._map=null,"undefined"==typeof module&&(this._map=new Map)}function showAlert(a){$("#alert_modal div.msg").html(a),$("#alert_modal").modal("show")}"undefined"!=typeof module&&(module.exports=Map),"undefined"!=typeof module&&(module.exports=NPC);var playerCount=0;if(Player.prototype.playerCount=function(){return playerCount},Player.prototype.login=function(a){return a!=this._password?!1:!0},Player.prototype.setSocket=function(a){this._socket=a},Player.prototype.getProfile=function(){return{username:this._username,health:this._health,vel:this._vel,bag:this._bag,equip:this._equip,zone:this._zone,world:this._world,pos:this._pos,created:this._created}},Player.prototype.setProfile=function(a){this._username=a.username,this._health=a.health,this._vel=a.vel,this._equip=a.equip,this._zone=a.zone,this._pos=a.pos,this._created=a.created,this._world=a.world},Player.prototype.updateDisplay=function(){console.log("display for ",this),$("#info_username").html(this._username),$("#info_zone").html(this._zone+" ["+this._pos[0]+","+this._pos[1]+"]"),$("#info_health").html(this._health)},Player.prototype.sendPing=function(){this._startPing=(new Date).getTime(),this._socket.emit("ping",{})},Player.prototype.receivePing=function(){this._endPing=(new Date).getTime(),this._latency=this._endPing-this._startPing,this._socket&&this._socket.emit("info",{latency:this._latency})},"undefined"!=typeof module&&(module.exports=Player),"undefined"!=typeof module)var cnf=require("./cnf");World.prototype.generate=function(a,b,c){this._name=a?a:b._name+"'s World",this._seed=this._name,console.log("Generating world "+this._name+" size "+this._size+" for "+b._username+" : "+typeof c);for(var d=!1,e=0;e<this._size;e++){this._mapData[e]=[];for(var f=0;f<this._size;f++){var g=Math.floor(Math.random()*cnf.TILES_MAX);this._mapData[e][f]=g,cnf.tiles[g].passable&&b&&!d&&(d=!0,b._pos=[e,f])}}console.log("map generated, triggering cb"),c()},"undefined"!=typeof module&&(module.exports=World);var cnf={title:"Ludum Dare 30",ws_server:"http://10.0.33.34:8001",TILES_MAX:4,TILE_TREE:0,TILE_GRASS:1,TILE_WATER:2,TILE_ROAD:3,tiles:[{i:0,name:"tree",passable:!1,tile_i:7},{i:1,name:"grass",passable:!0,tile_i:0},{i:2,name:"water",passable:!1,tile_i:10},{i:3,name:"road",passable:!0,tile_i:20}]};"undefined"!=typeof module&&(module.exports=cnf),CreateGame=function(a){return this._canvasID=a,this._canvasE=document.getElementById(a),this._socket=!1,this._connected=!1,this._authenticated=!1,this._zone=!1,this._world=!1,this._player=!1,this._canvasE?(this._canvasW=$(this._canvasE).width(),this._canvasH=$(this._canvasE).height(),this._canvasH||(this._canvasH=500),this.init=function(){this._p=new Phaser.Game(this._canvasW,this._canvasH,Phaser.CANVAS,this._canvasID,{preload:this.preload,create:this.create,update:this.update,render:this.render}),this._socket=io(cnf.ws_server);var a=this;$("#info_server").html("Connecting.."),$("#frm_msg").on("submit",function(){return console.log("form submitted! ",a.send_msg),a.send_msg(),!1}),this._socket.on("connect",function(){$("#info_server").html("Connected"),hideSpinner(),a._connected=!0,$("#login_modal").modal("show")}),this._socket.on("connect_error",function(){$("#info_server").html("Connect Failed"),a._connected=!1,a._socket.disconnect()}),this._socket.on("disconnect",function(){$("#info_server").html("Disconnected")}),this._socket.on("alert",function(a){console.log("alert",a),showAlert(a)}),this._socket.on("login",function(b){console.log("login response",b),processingLogin=!1,b.status?($("#info_server").html("Logged In"),$("#login_modal").modal("hide"),a._player=new Player(a._login_params.user,a._login_params.pwd),a._player.setProfile(b.profile),a._player.updateDisplay(),$("div.right").slideDown(),a._player.updateDisplay(),showSpinner("Loading "+a._player._zone)):(showAlert(b.err),hideSpinner())}),this._socket.on("world",function(b){console.log("Received world data from server!",b),$("#login_modal").modal("hide"),a._world=b,a._player._world=b,$("#info_zone").html(b._name),a.loadWorld()}),this._socket.on("chat message",function(b){a.received_msg(b.user,b.msg)}),this._socket.on("player login",function(b){a.received_msg("System",b+" has logged in")}),this._socket.on("ping",function(){a._socket.emit("ping")}),this._socket.on("info",function(a){"undefined"!=typeof a.latency&&$("#info_latency").html(a.latency+"ms"),"undefined"!=typeof a.position&&$("#info_position").html("x:"+a.position[0]+" y:"+a.position[1]),"undefined"!=typeof a.zone&&$("#info_zone").html(a.zone)})},this.received_msg=function(a,b){console.log("received chat",b);var c='<li style="float:left; width:100%;"><div style="float:left;max-width: 80px; font-weight: bold; margin-right: 5px; overflow-x:hidden;">';c+=a+"</div><div style='float:left;max-width:120px;overflow-x:wrap;'>"+b+"</div></li>",$("#chat_messages").append(c),$("#chat_div").scrollTop($("#chat_messages").height())},this.send_msg=function(){var a=$("#msg").val();!a||a.length<2||self._socket&&self._connected&&(console.log("sending msg",a),self._socket.emit("chat message",a))},this.preload=function(){console.log("Preloading .. "),self._p.load.image("tileset_world","assets/elona/map0.png"),self._p.load.image("tileset_map","assets/elona/map1.png"),self._p.load.spritesheet("chr1","assets/elona/char1.png",32,48)},this.create=function(){console.log("Game created .. "),self.map=self._p.add.tilemap(),self.map.addTilesetImage("tileset_map","tileset_map",48,48),self.layer=self.map.create("Intro",20,20,48,48),self.layer.resizeWorld(),self.sprite=self._p.add.sprite(10,10,"chr1"),self.sprite.animations.add("walk",0,4),self.sprite.animations.add("stand",0),self.sprite.animations.play("stand",1),console.log("sprite created",self.sprite),self.cursors=self._p.input.keyboard.createCursorKeys(),self.cursors.left.onDown.add(self.left),self.cursors.up.onDown.add(self.up),self.cursors.down.onDown.add(self.down),self.cursors.right.onDown.add(self.right),self.playable=!0,self.layer.debug=!0,self.map.fill(0,0,0,20,20,self.map.currentLayer);for(var a=Math.floor(40*Math.random()+20),b=0;a>b;b++){var c=Math.floor(20*Math.random()),d=Math.floor(20*Math.random()),e=Math.floor(Math.random()*cnf.TILES_MAX),f=self.map.putTile(cnf.tiles[e].tile_i,c,d,0);f.properties.i=e,f.properties.passable=cnf.tiles[e].passable}console.log("Intro tiles filled"),self.movePlayerTo(10,10),self._p.camera.follow(self.sprite)},this.update=function(){},this.up=function(){if(self.playable){var a=self.map.getTileAbove(self.map.currentLayer,self.curTile.x,self.curTile.y);a&&self.movePlayerTo(a.x,a.y)}},this.down=function(){if(self.playable){var a=self.map.getTileBelow(self.map.currentLayer,self.curTile.x,self.curTile.y);a&&self.movePlayerTo(a.x,a.y)}},this.left=function(){if(console.log("left!"),self.playable){var a=self.map.getTileLeft(self.map.currentLayer,self.curTile.x,self.curTile.y);a&&self.movePlayerTo(a.x,a.y)}},this.right=function(){if(self.playable){var a=self.map.getTileRight(self.map.currentLayer,self.curTile.x,self.curTile.y);a&&self.movePlayerTo(a.x,a.y)}},this.render=function(){self._p.debug.text("Current Layer: "+self.map.layers[self.map.currentLayer].name,16,550)},this.loadWorld=function(){showAlert("World data received - creating display"),$("#login_modal").modal("hide");var a=self.map.getLayer("world");null===a&&(wl=self.map.create("world",self._world._size,self._world._size,48,48),a=self.map.getLayer("world"));for(var b=0;b<self.map._mapData.length;b++)for(var c=0;c<self.map._mapData[b].length;c++)console.log(self.map._mapData[b][c],cnf.tiles[self.map._mapData[b][c]].tile_i),self.map.putTile(cnf.tiles[self.map._mapData[b][c]].tile_i,b,c,"world");self.map.setLayer("world");var d=Math.floor(self._world._size/2);self.movePlayerTo(d,centerY),self.playable=!0},this.movePlayerTo=function(a,b){var c=self.map.getTile(a,b,self.map.currentLayer);return console.log(c),c.properties.passable===!1?!1:(self.curTile=c,self.sprite.x=c.worldX+self.sprite.width/2,void(self.sprite.y=c.worldY+self.sprite.height/2))},this.doLogin=function(a){return self._connected?(showSpinner("Logging In.."),self._login_params=a,void self._socket.emit("login",a)):void console.log("Cant login not connected")},self):(alert("Missing canvas!"),!1)},console.log("ld30 game loaded - yay");