/*! ld30_game 2014-08-24 */
function Item(a,b,c){this._type=a,this._x=b,this._y=c,this._name="Test "+a+" Object",this._sprite=null,this.i=0,this._properties={}}function Map(a){this._data=a}function NPC(a,b,c){this._type=a,this._x=b,this._y=c,this._name="Test "+a+" NPC",this._sprite=null}function Player(a,b){this._username=a,this._password=b,this._created=(new Date).getTime(),this._socket=!1,this._zone="login",this._world="login",this._pos=[0,0],this._health=100,this._vel=[0,0],this._anim="standing",this._bag=[],this._equip={},this._model=!1,playerCount++}function SimplexNoise(a){"undefined"==typeof a&&(a=Math),this.grad3=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],this.p=[];for(var b=0;256>b;b++)this.p[b]=Math.floor(256*a.random());this.perm=[];for(var c=0;512>c;c++)this.perm[c]=this.p[255&c];this.simplex=[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]}function UI(a){this.game=a,this.menu=!1}function World(a,b){this._model=!1,this._name="Test World",this._seed="Test World",this._size=a,this._width=a,this._height=b,this._id_player=null,this._is_primary=!1,this._npcs=[],this._mapData=[],this._mapObjects=[],this._items=[],this._current_players=1,this._player_list={},this._map=null,this._spawnPoint=[0,0],this._biome=cnf.BIOME_GRASS,this._portals=[],"undefined"==typeof module&&(this._map=new Map)}function showAlert(a){$("#alert_modal div.msg").html(a),$("#alert_modal").modal("show")}"undefined"!=typeof module&&(module.exports=Item),"undefined"!=typeof module&&(module.exports=Map),"undefined"!=typeof module&&(module.exports=NPC);var playerCount=0;if(Player.prototype.playerCount=function(){return playerCount},Player.prototype.login=function(a){return a!=this._password?!1:!0},Player.prototype.setSocket=function(a){this._socket=a},Player.prototype.getProfile=function(){return{username:this._username,health:this._health,vel:this._vel,bag:this._bag,equip:this._equip,zone:this._zone,pos:this._pos,created:this._created}},Player.prototype.setProfile=function(a){this._username=a.username,this._health=a.health,this._vel=a.vel,this._equip=a.equip,this._zone=a.zone,this._pos=a.pos,this._created=a.created,this._world=a.world},Player.prototype.updateDisplay=function(){console.log("display for ",this),$("#info_username").html(this._username),$("#info_zone").html(this._zone+" ["+this._pos[0]+","+this._pos[1]+"]"),$("#info_health").html(this._health)},Player.prototype.sendPing=function(){this._startPing=(new Date).getTime(),this._socket.emit("ping",{})},Player.prototype.receivePing=function(){this._endPing=(new Date).getTime(),this._latency=this._endPing-this._startPing,this._socket&&this._socket.emit("info",{latency:this._latency})},"undefined"!=typeof module&&(module.exports=Player),SimplexNoise.prototype.dot=function(a,b,c){return a[0]*b+a[1]*c},SimplexNoise.prototype.noise=function(a,b){var c,d,e,f,g,h=.5*(Math.sqrt(3)-1),i=(a+b)*h,j=Math.floor(a+i),k=Math.floor(b+i),l=(3-Math.sqrt(3))/6,m=(j+k)*l,n=j-m,o=k-m,p=a-n,q=b-o;p>q?(f=1,g=0):(f=0,g=1);var r=p-f+l,s=q-g+l,t=p-1+2*l,u=q-1+2*l,v=255&j,w=255&k,x=this.perm[v+this.perm[w]]%12,y=this.perm[v+f+this.perm[w+g]]%12,z=this.perm[v+1+this.perm[w+1]]%12,A=.5-p*p-q*q;0>A?c=0:(A*=A,c=A*A*this.dot(this.grad3[x],p,q));var B=.5-r*r-s*s;0>B?d=0:(B*=B,d=B*B*this.dot(this.grad3[y],r,s));var C=.5-t*t-u*u;return 0>C?e=0:(C*=C,e=C*C*this.dot(this.grad3[z],t,u)),70*(c+d+e)},SimplexNoise.prototype.noise3d=function(a,b,c){var d,e,f,g,h,i,j,k,l,m,n=1/3,o=(a+b+c)*n,p=Math.floor(a+o),q=Math.floor(b+o),r=Math.floor(c+o),s=1/6,t=(p+q+r)*s,u=p-t,v=q-t,w=r-t,x=a-u,y=b-v,z=c-w;x>=y?y>=z?(h=1,i=0,j=0,k=1,l=1,m=0):x>=z?(h=1,i=0,j=0,k=1,l=0,m=1):(h=0,i=0,j=1,k=1,l=0,m=1):z>y?(h=0,i=0,j=1,k=0,l=1,m=1):z>x?(h=0,i=1,j=0,k=0,l=1,m=1):(h=0,i=1,j=0,k=1,l=1,m=0);var A=x-h+s,B=y-i+s,C=z-j+s,D=x-k+2*s,E=y-l+2*s,F=z-m+2*s,G=x-1+3*s,H=y-1+3*s,I=z-1+3*s,J=255&p,K=255&q,L=255&r,M=this.perm[J+this.perm[K+this.perm[L]]]%12,N=this.perm[J+h+this.perm[K+i+this.perm[L+j]]]%12,O=this.perm[J+k+this.perm[K+l+this.perm[L+m]]]%12,P=this.perm[J+1+this.perm[K+1+this.perm[L+1]]]%12,Q=.6-x*x-y*y-z*z;0>Q?d=0:(Q*=Q,d=Q*Q*this.dot(this.grad3[M],x,y,z));var R=.6-A*A-B*B-C*C;0>R?e=0:(R*=R,e=R*R*this.dot(this.grad3[N],A,B,C));var S=.6-D*D-E*E-F*F;0>S?f=0:(S*=S,f=S*S*this.dot(this.grad3[O],D,E,F));var T=.6-G*G-H*H-I*I;return 0>T?g=0:(T*=T,g=T*T*this.dot(this.grad3[P],G,H,I)),32*(d+e+f+g)},"undefined"!=typeof module&&(module.exports=SimplexNoise),UI.prototype.liClicked=function(a){console.log("List clicked",a);var b=parseInt($(a).attr("data-i"));null!==b&&game.ui.menu&&game.ui.menu[b]&&(console.log("option: ",game.ui.menu[b]),game.ui.menu[b].cb?game.ui.menu[b].cb():game.ui.closeMenu())},UI.prototype.keyPress=function(a){if(game.menuOpen&&game.ui.menu)if("up"==a||"down"==a){var b=$("li.menu_selected div").length>0?parseInt($("li.menu_selected div").attr("data-i")):0;$("li.menu_selected").removeClass("menu_selected");var c=b;"up"==a&&0===b?c=game.ui.menu.length-1:"up"==a?c=b-1:"down"==a&&b>=game.ui.menu.length-1?c=0:"down"==a&&(c=b+1),console.log("UI switch to menu option "+c),$('div[data-i="'+c+'"]').parent().addClass("menu_selected")}else if("space"==a){if($("li.menu_selected div").length<1)return;$("li.menu_selected div").click()}},UI.prototype.closeMenu=function(){game.ui.menu=!1,game.menu=!1,game.menuOpen=!1,$("#menu_modal div.close").click()},UI.prototype.showMenu=function(a){var b=a.header?a.header:"Menu",c=a.msg?a.msg:"";if($("#menu_modal h3").html(b),$("#menu_text").html(c),$("#menu_list").children().remove(),a.menu){game.ui.menu=a.menu,game.menu=a.menu;for(var d=0;d<a.menu.length;d++){var e='<li class="menu_list '+(0===d?"menu_selected":"")+'"><div data-i="'+d+'" onClick="game.ui.liClicked(this);">'+a.menu[d].txt+"</div></li>";$("#menu_list").append(e)}}console.log("Menu shown!",a),$("#menu_modal").modal(),game.menuOpen=!0},"undefined"!=typeof module)var cnf=require("./cnf");if("undefined"!=typeof module)var SimplexNoise=require("./SimplexNoise");if("undefined"!=typeof module)var NPC=require("./NPC");if("undefined"!=typeof module)var Item=require("./Item");World.prototype.generate=function(a,b,c,d){this._name=a?a:b._name+"'s World",this._seed=this._name,console.log("Generating world "+this._name+" ["+this._biome+"] size "+this._size+" for "+b._username+" : "+typeof d),-1===this._biome&&(this._biome=cnf.BIOMES[Math.floor(Math.random()*cnf.BIOMES.length)]),console.log("Generating biome: "+this._biome);var e=new SimplexNoise,f=6,g=[3,4,5],h=[0,1,2],i=[7],j=[6];this._biome==cnf.BIOME_SNOW?(g=[9,10,11],h=[12]):this._biome==cnf.BIOME_DESERT||this._biome==cnf.BIOME_CITY,this.occupiedTiles={};for(var k=!1,l=0;l<this._width;l++){this._mapData[l]=[];for(var m=0;m<this._height;m++){var n=0,o=(e.noise(l/this._width*f/2,m/this._height*f/2)+1)/2,p=0;switch(this._biome){case cnf.BIOME_GRASS:o>.9?(n=i[0],p=1):o>.65?(n=Math.floor((o-.65)/.35*h.length),n=h[n],p=1):.05>o&&(n=j[0],p=1);break;case cnf.BIOME_DESERT:break;case cnf.BIOME_SNOW:o>.9?(n=h[0],p=1):o>.52&&.6>o?(n=13,p=1):o>=.6&&.67>=o&&(n=14,p=1);break;case cnf.BIOME_FOREST:break;case cnf.BIOME_CITY:}if(p||(o=(e.noise(l/this._width*f,m/this._height*f)+1)/2,n=Math.floor(o*g.length),n=g[n]),cnf.tiles[n]||(n=0),this._mapData[l][m]=n,l>3&&m>3&&cnf.tiles[n].passable&&b&&!k)k=!0,b._pos=[l,m];else if(cnf.tiles[n].passable){if(o=Math.random(),o>.92){o=Math.random();var q=0;q=o>.8?2:o>.6?4:5,this._mapObjects.push({x:l,y:m,i:q,tile_i:cnf.blocks[q].tile_i}),cnf.blocks[q].passable||(this.occupiedTiles[l+","+m]=["block",this._mapObjects.length-1])}}else this.occupiedTiles[l+","+m]=["tile",n]}}console.log("map generated, populating with npcs");for(var r=25*Math.random()+10,s=!1,t=0,u=0,v=0,w=0;r>w;w++){var x=Math.floor(Math.random()*cnf.NPC_TYPE_LIST.length);for(s=!1,v=0;20>v&&!s;){if(t=Math.floor(Math.random()*this._width),u=Math.floor(Math.random()*this._height),!this.occupiedTiles[t+","+u]){s=[t,u];break}v++}if(s){var y=new NPC(cnf.NPC_TYPE_LIST[x],s[0],s[1]);this._npcs.push(y),this.occupiedTiles[s[0]+","+s[1]]=["npc",this._npcs.length-1]}}var z=25*Math.random()+12;for(w=0;z>w;w++){for(s=!1,v=0;20>v&&!s;){if(t=Math.floor(Math.random()*this._width),u=Math.floor(Math.random()*this._height),!this.occupiedTiles[t+","+u]){s=[t,u];break}v++}if(s){var A=new Item("portal",s[0],s[1]);c.link_portal&&!c.link_portal.linked?(A._name="Portal to "+c.link_portal.world_name,A._properties.is_explored=!0,A._properties.id_world=c.link_portal.id_world,A._properties.remote_id=c.link_portal.id_portal,c.link_portal.linked=!0,this.linked_portal=this._portals.length):(A._name="Mysterious Portal",A._properties.is_explored=!1),A.i=this._portals.length,this._portals.push(A),this.occupiedTiles[s[0]+","+s[1]]=["portal",this._portals.length-1]}}d&&d()},"undefined"!=typeof module&&(module.exports=World);var cnf={title:"Ludum Dare 30",ws_server:"http://10.0.33.34:8001",WORLD_SIZE_PLAYER:60,WORLD_SIZE_MAX:100,WORLD_SIZE_MIN:40,BIOME_GRASS:0,BIOME_SNOW:1,BIOME_DESERT:2,BIOME_CITY:3,BIOME_FOREST:4,TILES_MAX:4,TILE_TREE:0,TILE_GRASS:1,TILE_WATER:2,TILE_ROAD:3,tiles:[{i:0,name:"tree",passable:!0,tile_i:7},{i:0,name:"tree1",passable:!0,tile_i:8},{i:0,name:"tree2",passable:!0,tile_i:9},{i:1,name:"grass",passable:!0,tile_i:0},{i:2,name:"grass1",passable:!0,tile_i:1},{i:3,name:"grass2",passable:!0,tile_i:2},{i:0,name:"dirt",passable:!0,tile_i:38},{i:4,name:"water",passable:!1,tile_i:170},{i:5,name:"road",passable:!0,tile_i:78},{name:"snow",passable:!0,tile_i:45},{name:"snow1",passable:!0,tile_i:46},{name:"snow2",passable:!0,tile_i:47},{name:"snow_tree",passable:!1,tile_i:49},{name:"snow_ice_hole",passable:!0,tile_i:55},{name:"snow_ice",passable:!0,tile_i:60}],blocks:[{name:"stairs",passable:!0,interactable:!0,destructable:!1,tile_i:230},{name:"stairs1",passable:!0,interactable:!0,destructable:!1,tile_i:232},{name:"trap_arrow",passable:!0,interactable:!0,destructable:!0,tile_i:234},{name:"door_open",passable:!0,interactable:!0,destructable:!0,tile_i:236},{name:"campfire",passable:!0,interactable:!0,destructable:!0,tile_i:238},{name:"rock",passable:!1,interactable:!1,destructable:!0,tile_i:568}]};cnf.NPC_ATLAS={frames:{portal:{frame:{x:768,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},portal2:{frame:{x:816,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},portal3:{frame:{x:864,y:1008,w:48,h:96},rotated:!1,trimmed:!1,is_portal:!0},npcguy:{frame:{x:48,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcguy2:{frame:{x:96,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcguy3:{frame:{x:144,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcgirl:{frame:{x:192,y:0,w:48,h:48},rotated:!1,trimmed:!1},npcgirl2:{frame:{x:48,y:48,w:48,h:48},rotated:!1,trimmed:!1},bloodspurt:{frame:{x:53,y:1160,w:38,h:40},rotated:!1,trimmed:!1,not_npc:!0}}},cnf.BIOMES=[cnf.BIOME_GRASS,cnf.BIOME_GRASS,cnf.BIOME_GRASS,cnf.BIOME_GRASS,cnf.BIOME_SNOW,cnf.BIOME_SNOW,cnf.BIOME_FOREST,cnf.BIOME_FOREST,cnf.BIOME_DESERT],cnf.NPC_TYPES={},cnf.NPC_TYPE_LIST=[];for(var title in cnf.NPC_ATLAS.frames)"portal"!=title&&"portal2"!=title&&"portal3"!=title&&(cnf.NPC_ATLAS.frames[title].not_npc||(cnf.NPC_TYPES[title]=cnf.NPC_ATLAS.frames[title],cnf.NPC_TYPE_LIST.push(title)));cnf.ITEM_ATLAS={frames:{longstick:{frame:{x:48,y:0,w:48,h:48},rotated:!1,trimmed:!1},bullet:{frame:{x:96,y:0,w:48,h:48},rotated:!1,trimmed:!1},waterwisp:{frame:{x:144,y:0,w:48,h:48},rotated:!1,trimmed:!1},purplesplash:{frame:{x:192,y:0,w:48,h:48},rotated:!1,trimmed:!1}}},cnf.ITEM_TYPES={},cnf.ITEM_TYPE_LIST=[];for(var title in cnf.ITEM_ATLAS.frames)cnf.ITEM_TYPES[title]=cnf.ITEM_ATLAS.frames[title],cnf.ITEM_TYPE_LIST.push(title);cnf.TILES_MAX=cnf.tiles.length,"undefined"!=typeof module&&(module.exports=cnf),CreateGame=function(a){return this._canvasID=a,this._canvasE=document.getElementById(a),this._socket=!1,this._connected=!1,this._authenticated=!1,this._zone=!1,this._world=!1,this._player=!1,this._primary_world=!1,this._player_list={},this._local=!1,this._canvasE?(this._canvasW=$(this._canvasE).width(),this._canvasH=$(this._canvasE).height(),this._canvasH||(this._canvasH=500),this.init=function(){this._p=new Phaser.Game(this._canvasW,this._canvasH,Phaser.CANVAS,this._canvasID,{preload:this.preload,create:this.create,update:this.update,render:this.render}),this._socket=io(cnf.ws_server),this.ui=new UI(this);var a=this;$("#info_server").html("Connecting.."),$("#frm_msg").on("submit",function(){return console.log("form submitted! ",a.send_msg),a.send_msg(),!1}),$("#frm_warp").on("submit",function(){var b=$("#warp_id").val();if(b&&!(b.length<10))return a._socket.emit("warp",b),showAlert("Requesting warp"),!1}),this._socket.on("connect",function(){$("#info_server").html("Connected"),hideSpinner(),a._connected=!0,a._local||(a._world?(console.log("attempting to login automatically"),a._login_params.id_world=a._world._model._id,a._socket.emit("login",a._login_params),showSpinner("Reconnecting..")):$("#login_modal").modal("show"),console.log("socket connect"))}),this._socket.on("connect_error",function(){$("#info_server").html("Connect Failed"),showSpinner("Server Disconnected"),a.playable=!1,a._connected=!1}),this._socket.on("disconnect",function(){$("#info_server").html("Disconnected"),showSpinner("Server Disconnected")}),this._socket.on("alert",function(a){console.log("alert",a),showAlert(a)}),this._socket.on("pc",function(b){b.name!=a._player._username&&(console.log("pc",b),a._player_list[b.name]&&b.pos&&a.movePlayerTo(pos[0],pos[1],a._player_list[b.name]))}),this._socket.on("pc list",function(b){console.log("pc list",b),a.loadPlayers(b)}),this._socket.on("pc join",function(b){if(b.name!=a._player._username){console.log("pc join",b);var c=new Player(b.name,"");c._pos=b.pos,c.sprite=a._p.add.sprite(10,10,"chr1"),c.sprite.animations.add("walk",[0,1,2,3]),c.sprite.animations.add("stand",[0]),c.sprite.animations.play("stand",0),c.sprite.animations.add("walk_left",[4,5,6,7]),c.sprite.animations.add("walk_right",[8,9,10,11]),c.sprite.animations.add("walk_up",[12,13,14,15]),c.sprite.anchor.setTo(.5,.5),c.sprite.z=10,c.curTile=a.map.getTile(c._pos[0],c._pos[1],"world"),c.sprite.x=c.curTile.worldX+c.sprite.width/2,c.sprite.y=c.curTile.worldY+c.sprite.height/4,c.label=a._p.add.text(c.sprite.x,c.curTile.worldY-30,c._username,pStyle),c.sprite.bringToTop(),c.label.bringToTop(),a._player_list[b.name]=c,console.log(a._world._player_list)}}),this._socket.on("pc leave",function(b){a._player._username!=b.name&&(console.log("pc leave",b),a._player_list[b.name]&&(a._player_list[b.name].sprite&&a._player_list[b.name].sprite.destroy(!0),delete a._player_list[b.name]))}),this._socket.on("login",function(b){console.log("login response",b),processingLogin=!1,$("#login_modal").css("display","none"),$("div.modal-backdrop").css("display","none"),b.status?($("#info_server").html("Logged In"),a._player||a._world?(console.log("Reconnected"),hideSpinner(),a.playable=!0):(a._player=new Player(a._login_params.user,a._login_params.pwd),a._player.setProfile(b.profile),a._player.updateDisplay(),$("div.right").slideDown(),a._player.updateDisplay(),showSpinner("Loading "+a._player._zone))):(showAlert(b.err),hideSpinner())}),this._socket.on("world",function(b,c){"string"==typeof b&&(b=JSON.parse(b)),a.playable=!1,showSpinner("Loading world: "+b._name),console.log("Received world data from server!",b,c),a._world=b,a._player._world=b,b._is_primary&&!a._primary_world&&(a._primary_world={id:b._model._id,name:b._name,pos:c}),$("#info_zone").html(b._name),$("#info_zone_id").html(b._model._id),$("#login_modal").modal("hide"),a.loadWorld(c)}),this._socket.on("chat message",function(b){a.received_msg(b.user,b.msg)}),this._socket.on("player login",function(b){a.received_msg("System",b+" has logged in")}),this._socket.on("ping",function(){a._socket.emit("ping")}),this._socket.on("info",function(b){"undefined"!=typeof b.latency&&$("#info_latency").html(b.latency+"ms"),"undefined"!=typeof b.position&&($("#info_position").html("x:"+b.position[0]+" y:"+b.position[1]),a.movePlayerTo(b.position[0],b.position[1])),"undefined"!=typeof b.zone&&$("#info_zone").html(b.zone)})},this.received_msg=function(a,b){console.log("received chat",b);var c='<li style="float:left; width:100%;"><div style="float:left;max-width: 80px; font-weight: bold; margin-right: 5px; overflow-x:hidden;">';c+=a+"</div><div style='float:left;max-width:120px;overflow-x:wrap;'>"+b+"</div></li>",$("#chat_messages").append(c),$("#chat_div").scrollTop($("#chat_messages").height())},this.send_msg=function(){var a=$("#msg").val();!a||a.length<2||self._socket&&self._connected&&(console.log("sending msg",a),self._socket.emit("chat message",a))},this.preload=function(){console.log("Preloading .. "),self._p.load.image("tileset_map","assets/elona/map1tp.png"),self._p.load.spritesheet("chr1","assets/elona/char1.png",32,48),self._p.load.atlasJSONHash("npcs","assets/elona/npcs.png",null,cnf.NPC_ATLAS),self._p.load.atlasJSONHash("npcs","assets/elona/items.png",null,cnf.ITEM_ATLAS)},this.create=function(){console.log("Game created .. "),self.map=self._p.add.tilemap(),self.map.addTilesetImage("tileset_map","tileset_map",48,48),self.layer=self.map.create("Intro",20,20,48,48),self.layer.resizeWorld(),self.npcguy=self._p.add.sprite(200,200,"npcs","npcguy"),self.sprite=self._p.add.sprite(10,10,"chr1"),self.sprite.animations.add("walk",[0,1,2,3]),self.sprite.animations.add("stand",[0]),self.sprite.animations.play("stand",0),self.sprite.animations.add("walk_left",[4,5,6,7]),self.sprite.animations.add("walk_right",[8,9,10,11]),self.sprite.animations.add("walk_up",[12,13,14,15]),self.sprite.anchor.setTo(.5,.5),self.sprite.z=10,console.log("sprite created",self.sprite),self.cursors=self._p.input.keyboard.createCursorKeys(),self.cursors.space=self._p.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR),self.cursors.enter=self._p.input.keyboard.addKey(Phaser.Keyboard.ENTER),self.cursors.left.onDown.add(self.left),self.cursors.up.onDown.add(self.up),self.cursors.down.onDown.add(self.down),self.cursors.right.onDown.add(self.right),self.cursors.enter.onDown.add(self.space),self.cursors.space.onDown.add(self.space),self.playable=!0,self.layer.debug=!0,self.map.fill(0,0,0,20,20,self.map.currentLayer),self._p.camera.follow(self.sprite),self._local&&(self.test_world=new World(60,30),self.test_world._biome=-1,self.test_world.generate("Test World",self._player,function(){console.log("test world generated"),self._world=self.test_world,self._player._pos||(self._player._pos=[20,20]),self.loadWorld(self._player._pos)}))},this.update=function(){},this.up=function(){if(self.menuOpen)return void self.ui.keyPress("up");if(self.playable){var a=self.map.getTileAbove(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y)),b&&self.sprite.animations.play("walk_up",3)}},this.down=function(){if(self.menuOpen)return void self.ui.keyPress("down");if(self.playable){var a=self.map.getTileBelow(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y)),b&&self.sprite.animations.play("walk",3)}},this.left=function(){if(self.menuOpen)return void self.ui.keyPress("left");if(self.playable){var a=self.map.getTileLeft(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y)),b&&self.sprite.animations.play("walk_left",3)}},this.right=function(){if(self.menuOpen)return void self.ui.keyPress("right");if(self.playable){var a=self.map.getTileRight(0,self.curTile.x,self.curTile.y),b=!1;a&&(b=self.movePlayerTo(a.x,a.y)),b&&self.sprite.animations.play("walk_right",3)}},this.space=function(){return self.menuOpen?void self.ui.keyPress("space"):void 0},this.render=function(){self._p.debug.text("Current Layer: "+self.map.layers[self.map.currentLayer].name,16,550)},this.loadWorld=function(a){showAlert("World data received - creating display"),console.log("world data recieived - creating display",a),$("#info_zone").html(self._world._name);var b=self.map.getLayer("world");wl=self.map.create("world",self._world._mapData.length,self._world._mapData[0].length,48,48),self._worldlayer=wl,b=self.map.getLayer("world"),wl.resizeWorld();for(var c=null,d=0;d<self._world._mapData.length;d++)for(var e=0;e<self._world._mapData[d].length;e++)c=self.map.putTile(cnf.tiles[self._world._mapData[d][e]].tile_i,d,e,"world"),c.properties.i=self._world._mapData[d][e],c.properties.passable=cnf.tiles[self._world._mapData[d][e]].passable;console.log("Creating "+self._world._mapObjects.length+" blocks");var f=self.map.createBlankLayer("blocks",self._world._mapData.length,self._world._mapData[0].length,48,48);self._blocklayer=f;for(var g=0;g<self._world._mapObjects.length;g++)c=self.map.putTile(self._world._mapObjects[g].tile_i,self._world._mapObjects[g].x,self._world._mapObjects[g].y,"blocks"),c.properties.i=self._world._mapObjects[g].i,cnf.blocks[self._world._mapObjects[g].i]?(c.properties.passable=cnf.blocks[self._world._mapObjects[g].i].passable,c.properties.interactable=cnf.blocks[self._world._mapObjects[g].i].interactable):console.log("invalid block",self._world._mapObjects[g]);console.log("map layer set");var h=null;for(g=0;g<self._world._npcs.length;g++)h=self.map.getTile(self._world._npcs[g]._x,self._world._npcs[g]._y,"world"),self._world._npcs[g].curTile=h,self._world._npcs[g].sprite=self._p.add.sprite(h.worldX,h.worldY,"npcs",self._world._npcs[g]._type),self._world._npcs[g].sprite.anchor.setTo(.5,.5),self._world._npcs[g].sprite.y+=self._world._npcs[g].sprite.height/4,self._world._npcs[g].sprite.x+=self._world._npcs[g].sprite.width/2;for(g=0;g<self._world._portals.length;g++)h=self.map.getTile(self._world._portals[g]._x,self._world._portals[g]._y,"world"),self._world._portals[g].curTile=h,self._world._portals[g].sprite=self._p.add.sprite(h.worldX,h.worldY,"npcs"),self._world._portals[g].sprite.animations.add("bzz",["portal","portal2","portal3","portal2"],8*Math.random()+2,!0),self._world._portals[g].sprite.animations.play("bzz"),self._world._portals[g].sprite.anchor.setTo(.5,.5),self._world._portals[g].sprite.x+=self._world._portals[g].sprite.width/2;var i=Math.floor(self._world._width/2);a?self.movePlayerTo(a[0],a[1]):self.movePlayerTo(i,Math.floor(self._world._height/2)),self.playable=!0,self._p.camera.follow(self.sprite),self.sprite.bringToTop(),hideSpinner(),$("#login_modal").modal("hide"),console.log("loadWorld Finished"),setTimeout(function(){self._player._pos||(self._player._pos=[10,10],self.curTile=self.map.getTile(10,10,"world"),self.sprite.x=self.curTile.worldX+self.sprite.width/2,self.sprite.y=self.curTile.worldY+self.sprite.height/4),self.sprite.bringToTop()},100)},this.movePlayerTo=function(a,b,c){var d=self.map.getTile(a,b,"world"),e=self.map.getTile(a,b,"blocks");if(e&&!e.properties.passable)return!1;if(console.log(d),d.properties.passable===!1)return!1;if(self._world.occupiedTiles[a+","+b]){var f=self._world.occupiedTiles[a+","+b];if(console.log("Tile occupied",f),"npc"==f[0]){var g=self._p.add.emitter(d.worldX+d.width/2,d.worldY+d.height/2,30);g.makeParticles("npcs",["bloodspurt"]),g.maxParticleSpeed=8.5,g.start(!0,1500,3);var h=self._world._npcs[f[1]];h&&!h.lbl&&(h.lbl=self._p.add.text(h.sprite.x-10,h.sprite.y-35,"Oof!",{font:"14px Arial",fill:"#330000"}),setTimeout(function(){h.lbl.destroy(),h.lbl=!1},2500))}else if("portal"==f[0]){var i=self._world._portals[f[1]],j={header:i._name,msg:"This portal leads to another world which may be dangerous but also full of wonders. Step through at your own peril",menu:[{txt:"Step Away"},{txt:"Bravely Pass Through",cb:function(){self.activatePortal(f[1])}}]};console.log("showing portal menu"),self.ui.showMenu(j)}return!1}return $("#info_position").html(a+" , "+b),c?(c._pos=[a,b],c.curTile=d,c.sprite&&(c.sprite.x=d.worldX+c.sprite.width/2,c.sprite.y=d.worldY+c.sprite.height/4,c.sprite.bringToTop()),c.label&&(c.label.x=d.worldX+c.sprite.width/2,c.label.y=d.worldY-20),!0):(self._player._pos=[a,b],self.curTile=d,self.sprite.x=d.worldX+self.sprite.width/2,self.sprite.y=d.worldY+self.sprite.height/4,self.sprite.bringToTop(),self._socket.emit("move",[a,b]),!0)},this.activatePortal=function(a){self._world._portals[a]||(showAlert("Unable to find portal "+a+"!"),self.ui.closeMenu()),console.log("load world! ",self._world._portals[a]),showSpinner("Activating World Portal"),self.ui.closeMenu(),self.playable=!1;var b={portal_i:a};self._world._portals[a]._properties.is_explored&&(b.id_world=self._world._portals[a]._properties.id_world,b.to_portal=self._world._portals[a]._properties.remote_id),self._socket.emit("warp",{portal_i:a})},this.doLogin=function(a){return self._connected?(showSpinner("Logging In.."),self._login_params=a,void self._socket.emit("login",a)):void console.log("Cant login not connected")},this.loadPlayers=function(a){self.clearPlayerSprites(),console.log("loadPlayers sprites cleared");for(var b in a)if(console.log(a[b].name),a[b].name!=self._player._username){var c={font:"12px Arial",fill:"#ff0044",align:"center"},d=new Player(a[b].name,"");self._player_list[a[b].name]=d,d._pos=a[b].pos,d.sprite=self._p.add.sprite(10,10,"chr1"),d.sprite.animations.add("walk",[0,1,2,3]),d.sprite.animations.add("stand",[0]),d.sprite.animations.play("stand",0),d.sprite.animations.add("walk_left",[4,5,6,7]),d.sprite.animations.add("walk_right",[8,9,10,11]),d.sprite.animations.add("walk_up",[12,13,14,15]),d.sprite.anchor.setTo(.5,.5),d.sprite.z=10,d.curTile=self.map.getTile(d._pos[0],d._pos[1],"world"),d.sprite.x=d.curTile.worldX+d.sprite.width/2,d.sprite.y=d.curTile.worldY+d.sprite.height/4,d.label=self._p.add.text(d.sprite.x,d.curTile.worldY-30,d._username,c),d.sprite.bringToTop(),d.label.bringToTop(),self._player_list[a[b].name]=d,console.log("added player",d)}console.log("loaded players",self._player_list.length)},this.clearPlayerSprites=function(){for(var a in self._player_list)self._player_list.sprite.destroy();self._player_list={}},this.closeMenu=function(){self.menuOpen=!1,self.menu=!1},self):(alert("Missing canvas!"),!1)},console.log("ld30 game loaded - yay");